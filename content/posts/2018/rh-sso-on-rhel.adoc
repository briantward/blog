---
title: RH-SSO 7.2 on Red Hat Enterprise Linux 7.5 integrated with Identity Management or Directory Server
date: 2018-05-01T12:00:00-04:00
categories: ["middleware"]
tags: ["sso", "rh-sso","keycloak","authentication","authorization"]
language: en
slug: rh-sso-on-rhel7
---

# Installing a Base RH-SSO Server for integration with IdM

## RH-SSO server install.  This can be done with yum/rpm or zip.  Using zips allows you to leverage more middleware services on one VM/box.

```
$ unzip rh-sso-7.2.0.GA.zip
$ cd rh-sso-7.2/bin
$ ./add-user-keycloak.sh -u admin -p admin
```

## EAP server install.

```
$ jboss-eap-7.1.0.zip
$ cd jboss-eap-7.1
$ unzip rh-sso-7.2.0.GA-eap7-adapter.zip -d jboss-eap-7.1
$ unzip -o rh-sso-7.2.0.GA-saml-eap7-adapter.zip -d jboss-eap-7.1
$ cd bin
$ ./standalone.sh &
 ENTER
$ ./jboss-cli.sh -c --file=adapter-install.cli
$ ./jboss-cli.sh -c --file=adapter-install-saml.cli
$ fg 1
 CTRL+C
```

## Create certificates for the RH-SSO server:

- Create the base keystore using java keytool.

    ```
    $ keytool -genkeypair -alias pki-sso -keyalg RSA -keystore /opt/rh-sso-7.2/standalone/configuration/pki-sso.jks -storepass password --keypass password --dname "CN=pki-sso-4.rhc-lab.iad.redhat.com,O=RHC-LAB.IAD.REDHAT.COM"
    ```

- Create the certificate in PEM format from the keystore using the java keytool.

    ```
    $ keytool -exportcert  -keystore /opt/rh-sso-7.2/standalone/configuration/pki-sso.jks -alias pki-sso -keypass password -storepass password -file /opt/rh-sso-7.2/standalone/configuration/pki-sso.cer
    ```

## Create certificates for the EAP-APP server:
    
- Create the base keystore using java keytool.  Alternatively, on the first server startup one is generated by default and you can use that one.  

    ```
    $ keytool -genkeypair -alias eap-app -keyalg RSA -keystore /opt/rh-sso-7.2/standalone/configuration/eap-app.jks -storepass password --keypass password --dname "CN=pki-sso-4.rhc-lab.iad.redhat.com,O=RHC-LAB.IAD.REDHAT.COM"
    ```

- Create the certificate in PEM format from the keystore using the java keytool.

    ```
    $ keytool -exportcert  -keystore /opt/jboss-eap-7.1/standalone/configuration/eap-app.jks -alias eap-app -keypass password -storepass password -file /opt/jboss-eap-7.1/standalone/configuration/eap-app.cer
    ```


## Import opposing certificates into each server's truststore.  This one line command automatically creates the truststore and imports the certificate at the same time.

- Import the EAP certificate into the RH-SSO truststore.

    ```
    $ keytool -import -file /opt/jboss-eap-7.1/standalone/configuration/eap-app.cer -alias eap-app -keystore /opt/rh-sso-7.2/standalone/configuration/sso-trust.jks -keypass password -storepass password
    ```

- Import the RH-SSO certificate into the EAP truststore.

    ```
    $ keytool -import -file /opt/rh-sso-7.2/standalone/configuration/pki-sso.cer -alias pki-sso -keystore /opt/jboss-eap-7.1/standalone/configuration/eap-trust.jks -keypass password -storepass password
    ```


## Review all Java Keystores:

```
$ keytool -list -keystore /opt/jboss-eap-7.1/standalone/configuration/eap-trust.jks -keypass password -storepass password
$ keytool -list -keystore /opt/jboss-eap-7.1/standalone/configuration/eap-app.jks -keypass password -storepass password
$ keytool -list -keystore /opt/rh-sso-7.2/standalone/configuration/sso-trust.jks -keypass password -storepass password
$ keytool -list -keystore /opt/rh-sso-7.2/standalone/configuration/pki-sso.jks -keypass password -storepass password
```

## Edit the servers to use the keystores and truststores.

- Edit the RH-SSO standalone.xml:

    ```
               <security-realm name="ApplicationRealm">
                    <server-identities>
                        <ssl>
                            <keystore path="pki-sso.jks" relative-to="jboss.server.config.dir" keystore-password="password" alias="pki-sso" key-password="password"/>
                        </ssl>
                    </server-identities>
                    <authentication>
                        <local default-user="$local" allowed-users="*" skip-group-loading="true"/>
                        <properties path="application-users.properties" relative-to="jboss.server.config.dir"/>
                        <truststore path="sso-trust.jks" relative-to="jboss.server.config.dir" keystore-password="password"/>
                    </authentication>
                    <authorization>
                        <properties path="application-roles.properties" relative-to="jboss.server.config.dir"/>
                    </authorization>
                </security-realm>
    ```

- Edit the EAP-APP standalone.xml:

    ```
        <system-properties>
            <property name="javax.net.ssl.trustStorePassword" value="password"/>
            <property name="javax.net.ssl.trustStore" value="${jboss.server.config.dir}/eap-trust.jks"/>
        </system-properties>
    ```

    ```
                <security-realm name="ApplicationRealm">
                    <server-identities>
                        <ssl>
                            <keystore path="eap-app.jks" relative-to="jboss.server.config.dir" keystore-password="password" alias="eap-app" key-password="password"/>
                        </ssl>
                    </server-identities>
                    <authentication>
                        <truststore path="eap-app.jks" relative-to="jboss.server.config.dir" keystore-password="password"/>
                    </authentication>
                    <authorization>
                        <properties path="application-roles.properties" relative-to="jboss.server.config.dir"/>
                    </authorization>
                </security-realm>
    ```

## Run the servers and verify the configurations:

- Run RH-SSO with debug and tech preview profiles for Fine-Grained Authentication management

    ```
    /opt/rh-sso-7.2/bin/standalone.sh -Dkeycloak.profile=preview -Dsun.security.krb5.debug=true -Dsun.security.spnego.debug=true -b 0.0.0.0 &
    ```

- Run EAP-APP with a port offset on the sockets to prevent conflict with the RH-SSO server

    ```
    /opt/jboss-eap-7.1/bin/standalone.sh -b 0.0.0.0 -Djboss.socket.binding.port-offset=1000 -Djavax.net.debug=all &
    ```


## Build a test app for the EAP-APP server

- Clone the keycloak quickstarts.  Use community because it appears the RH-SSO quickstarts are not up-to-date.

    ```
    $ git clone git@github.com:keycloak/keycloak-quickstarts.git
    $ cd keycloak-quickstarts
    $ git checkout 3.4.3-Final
    $ cd app-profile-jee-jsp
    remove line '<file>${basedir}/config/keycloak.json</file>' from pom.xml
    $ mvn clean package -DskipTests
    $ cp target/app-profile-jsp.war $EAP-APP_HOME/standalone/deployments
    ```

- Add a client in the RH-SSO server.

    TODO: add GUI steps to do this.

- Add the keycloak deployment configuration for an OIDC app.

    ```
            <subsystem xmlns="urn:jboss:domain:keycloak:1.1">
                <secure-deployment name="app-profile-jsp.war">
                    <realm>hackathon</realm>
                    <auth-server-url>https://pki-sso-4.rhc-lab.iad.redhat.com:8443/auth</auth-server-url>
                    <public-client>true</public-client>
                    <ssl-required>EXTERNAL</ssl-required>
                    <resource>app-profile-jsp</resource>
                </secure-deployment>
            </subsystem>
    ```

- Add the keycloak deployment configuration for a SAML app.

    ```
            <subsystem xmlns="urn:jboss:domain:keycloak-saml:1.1">
                <secure-deployment name="app-profile-saml.war">
                    <SP entityID="app-profile-saml"
                        sslPolicy="EXTERNAL"
                        logoutPage="/index.jsp">
                        <Keys>
                            <Key signing="true">
                                <PrivateKeyPem>MIIEpAIBAAKCAQEAkJ92Z1dszZeuguXkRF8DzWkk/jumYvBxfL7cAcCiAWbNcUPC52Lktk3wdG005jG7bM8cFlhB/jS2tmGFc7yhPDxNmK0KDuFsfRs58XW7QCnwXu175cj+X7g2fNE3Pbg34rAB0KziHrzewadh/CLCBOH7YyUyizAud7LQcCSbTTJwSNOOGF52V2bSQnE/KXCcBE9rGsCWt5rBQKjtqTFU6Mry+h+Jz7azJYIzCViPob/a4tLv95k/cB1S6ZZDqcm7Ct/rOY5T+FjQlJlDO39Dbzv6H3f5+zBqw4h5hIxF5m5tVAcDj0ee2425zMUcYA/6dcZokKcgQXDxRQpcjRM9EwIDAQABAoIBAGXzhAyl3NWyMBum5JwuPwf3L1TpyAnHZrmB8qZpnctPJVTLaAKl/IVnvDLXKYt9U5sJBcvau+rwTj2T0fgc6a0E9c7DbWvADjLDlr1ZOX+qEQFaeRUr8+aWfhLPihnAW+U6Ho100pLIol/yF2kfN5cpl4X1GwR0Gs3XCImFxNVNt0WASj79Yqrk0KdSjCc/Ta1MWYAX/ZONMmy+aLB0/IklFegUlX2IjiTPHpOPePNtf7cy1E4CcW2JhEvl3Mf4rP/cXVdrkNpLQF6jOO3yei8ThpjmrEy+ltuN6c7VRJttBaoeBbLd4KwsDBX873thHK1rKqwfGig39/WReZh4pQECgYEA/qzt6E9A1lJB8EEtGdEvRE/Dirh9FkYmYPfEZ/41f+gwZggL9ydfLnjZgH5NvNlJbAk5EYv+qIW6m2djyBloSQ0JdEF2RlX/K1JO1ZfXnyiL1HeEBJGVGf2Q1blXJeaUsqT4UfUvCtsvk6xPRs5LLooK3wv5SGbcMWZhjA3ZywMCgYEAkWAC0Ua/BI6FxDFjxwwI1xTRWMG9drcrMzxXyrHHaFFoEKmsY296hI5aZMZ0NnaBw4llUc3YCFqFjJzIWvMo5fQIkm6f646Z3Q8GyNykoGkwUKzMyY1dPCYAedUNveU+e6caIbR/DBPNUxwFkBqnRewh5HDmBH81CsynZoo0oLECgYEAnrwKTRGYx/zdPHJjOgQ4Acv1hTEYRhnTMf08XdUEY4TFJdM+If5YRQ7uAji3G04ThVL6TwWC5Gb1uIbomn+7kEyf5+YlYhGXydizak4KBxmuje8wSeizlk+FRrEOsIDXjcFlRTAc8hdLwC9V+jv6gDdqLzu3VHlIJUI66qB3byECgYB9eJR1882iLTCe6NHpViW7HSiipnTUJbuPeSF8vHwTOU/MMeWr3OetyP+TwwVCjH3rOobMWBGBBEAH4Lm8ZeqCrmFHoVs9f9KkzPdaHbWpDaC5wKrvuqch5tq6THyTzWxkZRFUzehpkB3DAYh7m8WLwAZwmFCuyOwK6iABjH9nwQKBgQCM2DBjoRqO6/BJJ7VKYxloDFM/6UxF36p5lLXt6T0JTZ2HMsS9MQ3OrqlvKbBp78a+40t1xX1YUj19Oll3Og3dvRKS7TjyLuNpyT9NDsP1lAVdadriD2cqc3mhnX0gQqq9LaPoQUdrMTUD60l1qrbHKktYVCRCAmmcil3rJdh7mg==</PrivateKeyPem>
                                <CertificatePem>MIICrzCCAZcCBgFjA7nI7TANBgkqhkiG9w0BAQsFADAbMRkwFwYDVQQDDBBhcHAtcHJvZmlsZS1zYW1sMB4XDTE4MDQyNjIwNDk1N1oXDTI4MDQyNjIwNTEzN1owGzEZMBcGA1UEAwwQYXBwLXByb2ZpbGUtc2FtbDCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAJCfdmdXbM2XroLl5ERfA81pJP47pmLwcXy+3AHAogFmzXFDwudi5LZN8HRtNOYxu2zPHBZYQf40trZhhXO8oTw8TZitCg7hbH0bOfF1u0Ap8F7te+XI/l+4NnzRNz24N+KwAdCs4h683sGnYfwiwgTh+2MlMoswLney0HAkm00ycEjTjhhedldm0kJxPylwnARPaxrAlreawUCo7akxVOjK8vofic+2syWCMwlYj6G/2uLS7/eZP3AdUumWQ6nJuwrf6zmOU/hY0JSZQzt/Q287+h93+fswasOIeYSMReZubVQHA49HntuNuczFHGAP+nXGaJCnIEFw8UUKXI0TPRMCAwEAATANBgkqhkiG9w0BAQsFAAOCAQEAG5epvpBARkQP2Cg8jho0dNZfa97eDRIixthBCL34AFyAIwfPr8epeFyTYnXQ6ksZnMMXqASFWs95bM6uc5/sjK31AB5VvwtFJCg+LHvDwqCrH9p4nUGOlODaNPVjSWKNjMmf6vzgYmJyIlQH8i8l075rmBXwRwCv+iuWLkpb+Ra659ptpr74VUQMq6ENeQ6xwxu9YIiAjptXQygqi8YDObzveZUxhjdENCuFict4k23gzX5A71g8YIb4+YS5d8Asq+IkOBrZ9GJMhbVYsiwgXMNegj7ReVmH370zh5d9XAKmlQsI2BfvFIiyY8fnvVQwZRX+Gtf+pEfGZE3zg9Tqtg==</CertificatePem>
                            </Key>
                        </Keys>
                        <IDP entityID="idp"
                             signatureAlgorithm="RSA_SHA256"
                             signatureCanonicalizationMethod="http://www.w3.org/2001/10/xml-exc-c14n#">
                            <SingleSignOnService signRequest="true"
                                                 validateResponseSignature="true"
                                                 validateAssertionSignature="false"
                                                 requestBinding="POST"
                                                 bindingUrl="https://pki-sso-4.rhc-lab.iad.redhat.com:8443/auth/realms/hackathon/protocol/saml"/>
                            <SingleLogoutService signRequest="true"
                                                 signResponse="true"
                                                 validateRequestSignature="true"
                                                 validateResponseSignature="true"
                                                 requestBinding="POST"
                                                 responseBinding="POST"
                                                 postBindingUrl="https://pki-sso-4.rhc-lab.iad.redhat.com:8443/auth/realms/hackathon/protocol/saml"
                                                 redirectBindingUrl="https://pki-sso-4.rhc-lab.iad.redhat.com:8443/auth/realms/hackathon/protocol/saml"/>
                        </IDP>
                    </SP>
                </secure-deployment>
            </subsystem>
    ```

## Set up RH-SSO to federate with LDAP

TODO add GUI steps to do this.

 - ldap://pki-idm-4.rhc-lab.iad.redhat.com
 - cn=users,cn=accounts,dc=rhc-lab,dc=iad,dc=redhat,dc=com
 - CN=Directory Manager
 - redhat01


## Other

signing cert with IPA...
